---
title: "Trabalho Final"
author: "Olívia Silva Amann"
output:
  html_document: default
  pdf_document: default
---

FLP0468 Métodos Quantitativos de Pesquisa Política IV

# Reprodução dos modelos de regressão do artigo "O crescimento da direita e o voto em Bolsonaro: causalidade reversa?"

<br> Autores: G. Avelino; J. P. Junior; G. A. Russo <br>

## Introdução

<br> "O Crescimento da direita e o voto em Bolsonaro: causalidade reversa?", como o nome indica, é um artigo que busca inverter a lógica tradicionalmente estabelecida em grande parte da literatura que entende a posição ideológica autodeclarada como causa para a escolha do voto. Para os autores, uma das evidências disso é como, analisando a série histórica (Dados do Barômetro das Américas), no Brasil, não há aumento significativo do posicionamento conservador sobre temas de políticas públicas e costumes sociais, que é tão associada à direita.

<br> Para confirmar suas suspeitas, os autores realizaram surveys, tanto em entrevistas face a face quanto em questionários por telefone, respectivamente Experimentos 1 e 2, totalizando 4922 respondentes, todos de cidades paulistas e realizados em 2019. Nos surveys, constavam perguntas de mapeamento do perfil sociodemográfico, avaliação de satisfação com o presidente (e ex-presidente, no Experimento 2) e escala esquerda-direita para o autoposicionamento. O tratamento utilizado foi informar, antes do posicionamento na escala, como o então presidente Bolsonaro se identificava (direita), além do posicionamento do presidente Lula ou de ambos (também no Experimento 2) enquanto um grupo controle não recebia esse estímulo.

<br> Para este trabalho, reproduzirei as regressões apenas daquele que os autores chamam de "Experimento 1", ou seja, as entrevistas face a face.

## Reprodução das modelagens

### Carregamento de Bibliotecas

```{r warning=FALSE, message=FALSE}
library(haven)
library(dplyr)
library(broom)
#install.packages("ggplot2")
library(ggplot2)
#install.packages("patchwork")
library(patchwork)
```

### Carregamento de dados

```{r}
cidades_paulistas <- read_sav("2.BD_CausalidadeReversa_PesquisasCidadesPaulistas.sav")
#limpeza de dados
cidades_paulistas <- cidades_paulistas %>%
  mutate(across(where(is.character), ~ na_if(., ""))) %>%   
  mutate(across(where(is.character), ~ na_if(., " "))) %>%   
  mutate(across(where(is.character), ~ na_if(., "  ")))

experimento_1 <- cidades_paulistas %>%
  select(
    #autoposicionamento ideológico
    right, 
    left,
    l1_rec,
    l1_missing,
    l1_nomi,
    #avaliacao do presidente
    m1_cat,
    m1_recode,
    #tratamento
    treatment,
    #informações sociodemográficas
    female,
    age,
    educ_cat,
    income_cat,
    #cidade
    city,
    #neighborhood
  ) %>%
  rename(
    answered = l1_missing,
    l1_cat = l1_nomi,
    l1_desc = l1_rec
  ) %>%
  mutate(
    id=row_number(),
    treatment=factor(treatment),
    age=as.integer(age)
  )
```

Conforme os autores indicam nos apêndices do artigo, dentre as cidades analisadas, uma delas, Santos, não foi usada no artigo, já que seus dados de avaliação do desempenho presidencial tinham categorias diferentes das demais. Portanto, é preciso retirar todas as respostas de Santos da amostra.

```{r}
unique(experimento_1$city)
xp_1_fltr <- subset(experimento_1, city != "Santos")
glimpse(xp_1_fltr)
```

### Taxa de Respostas

<br> Antes de iniciar a regressão, é preciso determinar o grupo de referência, assim como no artigo, o grupo controle.

```{r}
xp_1_fltr <- xp_1_fltr %>%
  mutate(
    treatment=relevel(treatment, ref="Control")
  )
```

#### Usando renda como variável

<br> A Taxa de Respostas foi uma das formas que os autores utilizaram para identificar a influência do tratamento para que o respondente se identifique na escala ideológica. O objetivo é fundamentar a hipótese de que reconhecer o Bolsonaro como sendo de direita, impulsiona reações, mesmo que opostas.

<br> Este modelo, chamado aqui de `modelo_1a`, é uma regressão logística multivariada, é   apresentado na sessão de Resultados e busca  estabelecer uma relação de causalidade entre o tratamento e a taxa de respostas na escala de autoidentificação ideológica, independente de qual o valor dessa resposta (Esquerda, Direita ou Centro).

```{r}
modelo_1 <- glm(answered ~ treatment + city + income_cat + educ_cat + age + female + m1_cat,
                     data=xp_1_fltr,
                     family=binomial(link= "logit"))

summary_md1 <- summary(modelo_1)

#visualização em tabela
summary_md1a<- as.data.frame(summary_md1$coefficients)
summary_md1a <- round(summary_md1a, 3)
tabela_taxa_resp <- summary_md1a[
  c("(Intercept)", "treatmentTreatment"),
  c("Estimate", "Std. Error")
]
tabela_taxa_resp
```
<br> Segundo a tabela 23, no Apêndice G - Análise de Regressão - Taxa de Resposta, a renda não aparece entre as variáveis independentes do modelo. Essa é a razão da diferença entre os meus resultados da taxa de resposta para os presentes no artigo. Isso poderia indicar um viés, mas como podemos perceber, tanto pela regressão acima quanto pela predição abaixo, as diferenças entre ambas as respostas não são significativas:

<br> Para a predição de probabilidades, é necessário indicar os parâmetros de referência. Nos experimentos originais foram usados como padrão uma "mulher de 40 anos, moradora da cidade Guarujá, com ensino superior incompleto ou mais e avaliação “regular” do presidente Bolsonaro"(Avelino; Junior; Russo, 2022, p. 604). Contudo, os autores não indicaram qual o nível de renda parametrizado, mas seguindo a mesma lógica, podemos assumir que seria a renda com maior frequência, de Até 2 SM, como indicado no Apêndice C- Estatísticas Descritivas e Frequências do Estudo 1.

```{r}
moda_renda <- names(
  sort(
    table(xp_1_fltr$income_cat),
    decreasing = TRUE
  )
)[1]

persona <- data.frame(
  female = rep('Mulher',2),
  age=rep(40,2),
  city=rep('Guarujá', 2),
  educ_cat=rep('Superior incompleto ou mais', 2),
  m1_cat=rep(3, 2),
  treatment = c('Control', 'Treatment'),
  income_cat = rep(moda_renda, 2)
)

pred_respondeu <- predict(
  modelo_1,
  newdata=persona,
  type="response",
  se.fit = TRUE
)

pred_respondeu
```
### Sem Renda entre as variáveis
<br> Para reproduzir os resultados originais do estudo e confirmar que a omissão da renda não gera um viés, vou reproduzi-los abaixo e gerar a Tabela x: Comparação entre modelos com e sem renda.

```{r}
modelo_1b <- glm(
  answered ~ treatment + city + educ_cat + age + female + m1_cat,
  data=xp_1_fltr,
  family=binomial(link= "logit"))

summary_md1b <- summary(modelo_1b)


persona$income_cat<- NULL

pred_md_1b <- predict(
  modelo_1b,
  newdata=persona,
  type="response",
  se.fit=TRUE,
)

```
#### Comparação de Resultados
<br> Para comparar os resultados:
```{r}
summary_md1b <-as.data.frame(summary_md1b$coefficients)
summary_md1b <- round(summary_md1b, 3)

summary_md1a$Signif<-cut(
  summary_md1a$`Pr(>|z|)`,
  breaks = c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
  labels=c("***", "**", "*", ".", "")
)
summary_md1b$Signif<-cut(
  summary_md1b$`Pr(>|z|)`,
  breaks = c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
  labels=c("***", "**", "*", ".", "")
)

tabela_comp_taxa_resp <- rbind(
  "Controle – Sem renda" = summary_md1b["(Intercept)", c("Estimate", "Std. Error", "Signif")],
  "Tratamento – Sem renda" = summary_md1b["treatmentTreatment", c("Estimate", "Std. Error", "Signif")],
  "Controle – Com renda" = summary_md1a["(Intercept)", c("Estimate", "Std. Error", "Signif")],
  "Tratamento – Com renda" = summary_md1a["treatmentTreatment", c("Estimate", "Std. Error", "Signif")]
)


knitr::kable(tabela_comp_taxa_resp,
             caption = "Tabela x: Comparação entre estimandos e erros quadrados para os modelos com e sem renda")
```
<br> Apesar de os valores da minha reprodução serem diferentes aos do artigo, isso provavelmente se deve à adoção de alguma forma diferente para tratar os dados. Apesar disso, são valores que estão dentro da taxa de erros estabelecida no artigo. De forma parecida, a diferença entre os modelos com e sem renda também não é estatisticamente significativa, justificando a decisão dos persquisadores de não a utilizarem na regressão. Também é possível observar que nos quatro casos há alta significância, com um p valor inferior a 0.001.

### Representação gráfica

```{r}
#calcular intervalo das predições
ic_1a <- data.frame(
  Condicao = c("Controle", "Tratamento"),
  Porcentagem = pred_respondeu$fit * 100,
  Inferior = (pred_respondeu$fit - 1.96 * pred_respondeu$se.fit) * 100,
  Superior = (pred_respondeu$fit + 1.96 * pred_respondeu$se.fit) * 100
)

ic_1b <- data.frame(
  Condicao = c("Controle", "Tratamento"),
  Porcentagem = pred_md_1b$fit * 100,
  Inferior = (pred_md_1b$fit - 1.96 * pred_md_1b$se.fit) * 100,
  Superior = (pred_md_1b$fit + 1.96 * pred_md_1b$se.fit) * 100
)

#gráfico

g1a <- ggplot() +
  geom_point(
    data = ic_1a,
    aes(x = Condicao, y = Porcentagem),
    size = 3
  ) +
  geom_errorbar(
    data = ic_1a,
    aes(x = Condicao, ymin = Inferior, ymax = Superior),
    width = 0.2
  ) +
  labs(
    x = "Condição",
    y = "Porcentagem (%)",
    title = "Modelo com Renda"
  )

g1b <- ggplot() +
  geom_point(
    data = ic_1b,
    aes(x = Condicao, y = Porcentagem),
    size = 3
  ) +
  geom_errorbar(
    data = ic_1b,
    aes(x = Condicao, ymin = Inferior, ymax = Superior),
    width = 0.2
  ) +
  labs(
    x = "Condição",
    y = "Porcentagem (%)",
    title = "Modelo sem Renda"
  )

g1a+g1b
```

### Teste de Balanço

<br> Para garantir que a distribuição do tratamento seja mesmo aleatoriamente distribuída e que não tenha um viés, realizaremos um teste de balanço, que busca demonstrar se há ou não um padrão dentre os grupos controle e tratamento. Os resultados dos testes de balanço originais, podem ser encontrados no Apêndice E - Teste de balanço do estudo 1, na página 14 dos apêndices.
  Percebe-se que nos testes de balanço originais, a avaliação do presidente não consta, mas acredito que, mesmo não sendo uma variável sociodemografica, é uma variável que pode influenciar fortemente, caso não esteja aleatoriamente distribuído entre grupos controle e tratamento, talvez não tanto para a regressão presente neste trabalho, mas especialmente nas que consideram a o posicionamento dos respondentes na escala esquerda-direita
```{r}
teste_balanco <- glm(
  treatment ~ city + income_cat + educ_cat + age + female + m1_cat,
  data=xp_1_fltr,
  family = binomial(link="logit")
)

balance_summary <- summary(teste_balanco)
balance_summary <-as.data.frame(balance_summary$coefficients)
balance_summary <- round(balance_summary, 3)
balance_summary$Signif<-cut(
  balance_summary$`Pr(>|z|)`,
  breaks = c(-Inf, 0.001, 0.01, 0.05, 0.1, Inf),
  labels=c("***", "**", "*", ".", "(não significante)")
)

balance_tabela <- balance_summary[
  ,
  
  c("Estimate", "Std. Error", "Signif")
]

knitr::kable(balance_tabela,
             caption = "Tabela x+1: Teste de Balanço")
```
<br> Como idicado na tabela, nenhuma das variáveis têm significância, de forma que tenhamos, nem mesmo a categoria adicionada, que não acontece originalmente no apêndice do trabalho, a m1_cat, onde está armazenada as informações de avalaiação do então presidente Bolsonaro. Sendo assim, o teste de balanço demonstra que não há viés, ou padrão na distribuição das variaveis independentes entre os grupos controle e tratamento.

### Análise de Resíduos

<br> A análise de resíduos tendem a não aparecer em trabalhos acadêmicos, mas são de suma importância para o pesquisador validar seu modelo. Os resíduos são possíveis influências que variáveis aleatórias exercem sobre o resultado dos modelos. Caso não haja padrão claro entre os resíduos, podemos assumir que essas variáveis são realmente aleatória. Contudo se observarmos um padrão nos resíduos, há uma forte indicação de que alguma variável foi ignorada e, portanto, o modelo tem um viés.

<br> Neste trabalho faremos apenas a checagem de resíduos para o modelo de Taxa de Respostas do trabalho original, ou seja, sem usar a renda como variável independente (o chamado de `modelo_1b`). Por ser um modelo de regressão logística, adotaremos os resíduos de Pearson:
```{r}
residuos <- modelo_1b %>%
  residuals(type="pearson")
``` 
<br> Usando os resíduos de Pearson, podemos explorar os Gráficos quantil-quantil, que busca avaliar a normalidade dos resíduos.
```{r}
ggplot(data=NULL, 
       aes(sample=residuos))+
  stat_qq(alpha=0.6,
          color="deepskyblue",
          size=2) +
  stat_qq_line(color="hotpink",
               size=1)+
  labs(title = "Gráficos 2: QQ-PLOT - Normaliade dos Resíduos")
```
<br> A normalidade dos resíduos não é um pressuposto das regressões logísticas, contudo é esperado que os resíduos estejam separados em grupos respectivos de valores positivos e negativos, relativos aos valores 1 e 0. Apesar de conseguirmos perceber alguns pontos afastadosno final de cada uma das curvas dos resíduos, eles representam um bom padrão para regressões logísticas, enquanto a maior inclinação da curva respectiva a 0, demonstra que o modelo tem permite maior segurança ao prever as resposta positivas (1).

<br> Para a segunda parte da análise, bsucaremos checar a homocedasticidade dos resíduos. Isto é, se há uma distribuição homogênea desses resíduos. Para isso, checamos a constância da variância, a partir de um gráfico dos resíduos quadrados em comparação os valores ajustados, representados pela reta do gráfico:
```{r}
residuos2 <-residuos^2
ajustados <- fitted(modelo_1b)

df_homocedast <- data.frame(
  ajustados = ajustados,
  residuos2 = residuos2
)
  
  ggplot(df_homocedast, 
         aes(x = ajustados, y = residuos2)) +
    geom_point(alpha=0.5,
               color="deepskyblue") +
    geom_hline(yintercept = mean(df_homocedast$residuos2),
               color="hotpink")+
    labs(
      title = "Resíduos² vs valores ajustados"
    ) +
    theme_minimal()

```
<br> No caso das regressões logísticas, por serem variáveis binárias, a homocedasticidade esperada nos resíduos é diferente da de outras regressões: é necessário que haja homogeneidade na distribuição dos resíduos acima e abaixo da média (dos valores ajustados). E é isso que podemos observar no gráfico 2. 

<br> Concluindo: apesar daquilo que poderiam ser consideradas falhas encontradas no artigo, como a omissão da avaliação do presidente nos testes de balanço, ou da renda como uma variável independente da regressão logística, as análises estatísticas e residuais confirmam que o modelo é válido e significante.